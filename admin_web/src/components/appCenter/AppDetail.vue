<script setup lang="ts">
import { ArrowDown, ArrowRight, Close, Edit, Expand, Fold, MoreFilled, Plus } from '@element-plus/icons-vue';
import { ElMessage, genFileId, type UploadInstance, type UploadRawFile } from 'element-plus';
import { defineProps, nextTick, onMounted, reactive, ref, watch } from 'vue';
import {
  api,
  appDetail,
  workflowExport,
  workflowCreate,
  workflowDelete,
  workflowUpdate,
  workflowImport,
  appUpdate, workflowRestore
} from '@/api/appCenterApi';
import { delete_session as deleteSession, update_session as updateSession } from '@/api/next_console';
import { currentAppConfigArea, configArea, IConfigArea } from '@/components/appCenter/ts/app-config';
import {
  currentApp,
  currentSessionList,
  getWorkFlowSession,
  initCurrentApp,
  openedSubPage,
  showSetPanel,
  currentFlowList,
  ISubPage
} from '@/components/appCenter/ts/app-detail';
import {
  agentAppRef,
  CurrentEditFlow,
  CurrentEditSession,
  graphWrapper,
  initCurrentWorkflowEdit,
  showAgentApp,
  showEdgeFlag,
  showNodeFlag
} from '@/components/appCenter/ts/workflow-edit';
import router from '@/router';
import { IWorkflowMetaInfo } from '@/types/appCenterType';
import { session_item as ISessionItem } from '@/types/next_console';
import { getToken } from '@/utils/auth';

const prop = defineProps({
  appCode: {
    type: String,
    default: ''
  }
});
const showNewFlowForm = ref(false);
const currentFlowListDetail = ref(true);
const metaDialogFlag = ref(false);
const currentResourceListDetail = ref(true);
const currentResourceList = ref([]);
const currentSessionListFlag = ref(true);
const currentAppConfigFlag = ref(true);
const currentSessionTopicInputRef = ref();
const sessionButtonsRef = ref();
const newAppFormRules = {
  app_name: [
    { required: true, message: '请输入应用名称', trigger: 'blur' },
    { message: '应用名称长度不能超过20个字符', trigger: 'blur', max: 20 }
  ],
  app_desc: [{ required: true, message: '请输入应用描述', trigger: 'blur' }],
  app_icon: [{ required: true, message: '请上传应用图标', trigger: 'change' }]
};
const newFlowFormRef = ref(null);
const newFlowFormRules = {
  workflow_name: [{ required: true, message: '请输入名称', trigger: 'blur' }],
  workflow_desc: [{ required: true, message: '请输入描述', trigger: 'blur' }],
  workflow_icon: [{ required: true, message: '请输入图标', trigger: 'blur' }]
};
const showDeleteFlowConfirm = ref(false);
const deleteFlow = ref<IWorkflowMetaInfo | null>(null);
const showFlowUpdateForm = ref(false);
const updateFlow = reactive<IWorkflowMetaInfo | null>({
  workflow_schema: '',
  workflow_edit_schema: '',
  workflow_status: '',
  workflow_name: '',
  workflow_desc: '',
  workflow_code: '',
  workflow_icon: '',
  id: 0
});
const FlowUpdateFormRef = ref(null);
const defaultFlow = reactive<IWorkflowMetaInfo>({
  user_id: 0,
  workflow_schema: '',
  workflow_edit_schema: '',
  workflow_status: '',
  workflow_name: '',
  workflow_desc: '',
  workflow_code: '',
  workflow_icon: '',
  id: 0
});
const uploadHeader = {
  // eslint-disable-next-line @typescript-eslint/naming-convention
  Authorization: 'Bearer ' + getToken()
};
const showNewWorkFlowUploadForm = ref(false);
const newUploadWorkFlowFormRef = ref(null);
const uploadWorkFlowLoading = ref(false);
const newUploadWorkFlowForm = reactive({
  uploadFileUrl: ''
});
const newUploadWorkFlowFormRules = {
  uploadFileUrl: [{ required: true, message: '请上传工作流文件', trigger: 'blur' }]
};
const uploadRef = ref<UploadInstance>();
const currentAppRef = ref(null);
const currentAppMode = ref('logic');
const currentPage = ref<ISubPage>({});
const showRestoreConfirm = ref(false);
const restoreFlow = ref<IWorkflowMetaInfo | null>(null);
async function beginInitWorkFlow() {
  showNewFlowForm.value = true;
  defaultFlow.workflow_name = '';
  defaultFlow.workflow_code = '';
  defaultFlow.workflow_icon = 'images/workflow.svg';
}
async function handleWorkFlowIconUploadSuccess(res: any) {
  if (!res.error_status) {
    defaultFlow.workflow_icon = res.result.workflow_icon;
  }
}
async function beginDeleteWorkFlow(workflow: IWorkflowMetaInfo) {
  showDeleteFlowConfirm.value = true;
  deleteFlow.value = workflow;
}
function beforeAvatarUpload(file: File) {
  const isLt5M = file.size / 1024 / 1024 < 5;
  if (!isLt5M) {
    ElMessage.info('上传头像图片大小不能超过 5MB!');
  }
  uploadHeader.Authorization = 'Bearer ' + getToken();
  return isLt5M;
}
async function routerToPublish() {
  if (currentApp?.app_code) {
    if (currentApp.app_status != '已删除') {
      await router.push({
        name: 'publishCreate',
        params: {
          appCode: currentApp?.app_code
        }
      });
    } else {
      await router.push({
        name: 'publishDetail',
        params: {
          appCode: currentApp?.app_code
        }
      });
    }
  }
}
async function confirmUpdateWorkflow() {
  const validRes = await FlowUpdateFormRef.value.validate();
  if (!validRes) return;
  showFlowUpdateForm.value = false;
  updateFlow.app_code = currentApp.app_code;
  const res = await workflowUpdate({
    app_code: currentApp.app_code,
    workflow_code: updateFlow.workflow_code,
    workflow_name: updateFlow.workflow_name,
    workflow_desc: updateFlow.workflow_desc,
    workflow_icon: updateFlow.workflow_icon
  });
  if (!res.error_status) {
    // 更新列表
    const index = currentFlowList.value.findIndex(item => item.workflow_code === updateFlow.workflow_code);
    currentFlowList.value[index] = res.result;
    // 更新标签页
    openedSubPage.value.forEach(item => {
      if (item.pageCode === updateFlow.workflow_code) {
        item.pageName = res.result.workflow_name;
        item.pageIcon = res.result.workflow_icon;
      }
    });
    // 初始化UpdateWorkflow
    updateFlow.workflow_name = '';
    updateFlow.workflow_desc = '';
    updateFlow.workflow_icon = '';
    ElMessage.success('更新成功!');
  }
}
async function newFlowFormSubmit() {
  const validRes = await newFlowFormRef.value.validate();
  if (!validRes) return;
  const params = {
    app_code: currentApp.app_code,
    workflow_name: defaultFlow.workflow_name,
    workflow_icon: defaultFlow.workflow_icon,
    workflow_desc: defaultFlow.workflow_desc,
    workflow_is_main: currentFlowList.value.length === 0
  };
  const res = await workflowCreate(params);
  if (!res.error_status) {
    showNewFlowForm.value = false;
    currentFlowList.value.push(res.result);
    // @ts-ignore
    await openWorkFlowEdit({
      appCode: currentApp.app_code,
      workflow_code: res.result.workflow_code,
      workflow_name: res.result.workflow_name,
      workflow_icon: res.result.workflow_icon
    });
  }
}
async function beginUpdateWorkFlow(workflow: IWorkflowMetaInfo) {
  showFlowUpdateForm.value = true;
  Object.assign(updateFlow, workflow);
}
async function confirmDeleteWorkFlow() {
  showDeleteFlowConfirm.value = false;
  closeSubPage({
    appCode: currentApp.app_code,
    pageCode: deleteFlow.value.workflow_code,
    pageName: deleteFlow.value.workflow_name,
    pageIcon: deleteFlow.value.workflow_icon
  });
  const res = await workflowDelete({
    app_code: currentApp.app_code,
    workflow_code: deleteFlow.value.workflow_code
  });
  if (!res.error_status) {
    const deleteSubPageIdx = openedSubPage.value.findIndex(item => item.pageCode === deleteFlow.value.flow_code);
    if (deleteSubPageIdx > -1) {
      closeSubPage(openedSubPage.value[deleteSubPageIdx]);
    }
    const res = await appDetail({
      app_code: currentApp.app_code
    });
    if (!res.error_status) {
      currentFlowList.value = res.result.flows;
    }
    ElMessage.success('删除成功!');
  }
  deleteFlow.value = null;
  showAgentApp.value = false;
  currentSessionList.value = [];
  showNodeFlag.value = false;
  showEdgeFlag.value = false;
}
async function setMainWorkflow(workflow: IWorkflowMetaInfo) {
  const res = await workflowUpdate({
    app_code: currentApp.app_code,
    workflow_code: workflow.workflow_code,
    workflow_is_main: true
  });
  if (!res.error_status) {
    currentFlowList.value.forEach(item => {
      item.workflow_is_main = false;
    });
    workflow.workflow_is_main = true;
    ElMessage.success('设置成功!');
  }
}
async function exportTargetWorkflow(workflow: IWorkflowMetaInfo) {
  const res = await workflowExport({
    app_code: currentApp.app_code,
    workflow_code: workflow.workflow_code
  });
  if (!res.error_status) {
    const blob = new Blob([JSON.stringify(res.result)], {
      type: 'application/json;charset=utf-8'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentApp.app_code}_${workflow.workflow_code}.json`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
  }
}
async function handleExceed(files) {
  uploadRef.value!.clearFiles();
  const file = files[0] as UploadRawFile;
  file.uid = genFileId();
  uploadRef.value!.handleStart(file);
  uploadRef.value.submit();
}
async function importTargetWorkflow() {
  const validRes = await newUploadWorkFlowFormRef.value.validate();
  if (!validRes) return;
  uploadWorkFlowLoading.value = true;
  const res = await workflowImport({
    app_code: currentApp.app_code,
    workflow_schema_url: newUploadWorkFlowForm.uploadFileUrl
  });
  if (!res.error_status) {
    showNewWorkFlowUploadForm.value = false;
    ElMessage.success('导入成功');
    initCurrentApp(currentApp.app_code);
  } else {
    ElMessage.error('导入失败');
  }
  uploadWorkFlowLoading.value = false;
  newUploadWorkFlowForm.uploadFileUrl = '';
  uploadRef.value!.clearFiles();
}
function closePanel() {
  showSetPanel.value = false;
  router.replace({
    params: {
      ...router.currentRoute.value.params
    },
    query: {
      ...router.currentRoute.value.query,
      showPanel: 'false'
    }
  });
  showNodeFlag.value = false;
  showEdgeFlag.value = false;
}
function openPanel() {
  showSetPanel.value = true;
  router.replace({
    params: {
      ...router.currentRoute.value.params
    },
    query: {
      ...router.currentRoute.value.query,
      showPanel: 'true'
    }
  });
}
async function autoOpenFlow() {
  for (let workflow of currentFlowList.value) {
    if (workflow.workflow_is_main) {
      await openWorkFlowEdit(workflow);
      showAgentApp.value = false;
      return;
    }
  }
  // 如果没有主流程，则打开第一个工作流
  if (currentFlowList.value.length > 0) {
    await openWorkFlowEdit(currentFlowList.value[0]);
    showAgentApp.value = false;
    return;
  }
  currentSessionList.value = [];
  showAgentApp.value = false;
}
async function focusSessionTopicInput(item: ISessionItem) {
  item.is_edit = true;
  await nextTick();
  currentSessionTopicInputRef.value?.[0].focus();
  for (let i = 0; i < sessionButtonsRef.value.length; i++) {
    sessionButtonsRef.value[i]?.hide();
  }
}
async function panelRewriteSessionTopic(item: ISessionItem) {
  let params = {
    session_id: item.id,
    session_topic: item.session_topic
  };
  let res = await updateSession(params);
  if (!res.error_status) {
    await getWorkFlowSession(CurrentEditFlow.value);
    ElMessage.success('修改成功');
  }
}
async function panelDeleteSession(item: ISessionItem) {
  let params = {
    session_id: item.id
  };
  let res = await deleteSession(params);
  if (!res.error_status) {
    await getWorkFlowSession(CurrentEditFlow.value);
    ElMessage.success('删除成功');
  }
  for (let i = 0; i < sessionButtonsRef.value.length; i++) {
    sessionButtonsRef.value[i]?.hide();
  }
  showAgentApp.value = false;
}
async function changeTestSession(item: ISessionItem) {
  await agentAppRef.value?.changeTestSession(currentApp.app_code, item.session_code);
  CurrentEditSession.value = item;
  showAgentApp.value = true;
}
async function handleWorkFlowUploadSuccess(res: any) {
  if (!res.error_status) {
    newUploadWorkFlowForm.uploadFileUrl = res.result.app_flow_schema_url;
  }
}
async function handleAvatarUploadSuccess(res: any) {
  if (!res.error_status) {
    currentApp.app_icon = res.result.app_icon;
  }
}
async function updateCurrentApp() {
  const validRes = await currentAppRef.value.validate();
  if (!validRes) {
    return;
  }
  const res = await appUpdate(currentApp);
  if (!res.error_status) {
    Object.assign(currentApp, res.result);
    ElMessage.success('更新成功');
  }
}
async function openSubPage(page: ISubPage) {
  // 加入到已打开的子页面列表
  console.log('openSubPage:', page);
  let findFlag = false;
  openedSubPage.value.forEach(item => {
    if (item.pageCode === page.pageCode) {
      findFlag = true;
    }
  });
  if (!findFlag) {
    openedSubPage.value.push({
      appCode: currentApp.app_code,
      pageCode: page.pageCode,
      pageName: page.pageName,
      pageIcon: page.pageIcon,
      pageSource: page.pageSource
    });
  }
  // 保存至localstorage
  localStorage.setItem('openedSubPage', JSON.stringify(openedSubPage.value));
  // 保存工作流
  if (currentPage.value?.pageSource == 'workflow') {
    const graphData = graphWrapper.value?.toJSON();
    if (graphData) {
      const jsonData = JSON.stringify(graphData, null, 2);
      workflowUpdate({
        app_code: currentApp.app_code,
        workflow_code: CurrentEditFlow.value.workflow_code,
        workflow_edit_schema: jsonData
      });
    }
  }
  showAgentApp.value = false;
  showNodeFlag.value = false;
  showEdgeFlag.value = false;
  currentPage.value = page;
  if (page.pageSource === 'appConfig') {
     router.push({
      name: 'configEdit',
      params: {
        area: page.pageCode
      }
  })} else if (page.pageSource === 'workflow') {
    // 跳转到工作流编辑页面
    await router.push({
      name: 'workflowEdit',
      params: {
        workflowCode: page.pageCode
      }
    });
    initCurrentWorkflowEdit(currentApp.app_code, page.pageCode);
  }
}
async function closeSubPage(page: ISubPage) {
  // 关闭子页面
  const index = openedSubPage.value.findIndex(item => item.pageCode === page.pageCode);
  openedSubPage.value.splice(index, 1);
  // 保存工作流
  if (currentPage.value?.pageSource == 'workflow' && currentPage.value?.pageCode == page.pageCode) {
    const graphData = graphWrapper.value?.toJSON();
    if (graphData) {
      const jsonData = JSON.stringify(graphData, null, 2);
      workflowUpdate({
        app_code: currentApp.app_code,
        workflow_code: CurrentEditFlow.value.workflow_code,
        workflow_edit_schema: jsonData
      });
    }
    CurrentEditFlow.value.workflow_code = '';
  }
  // 跳转到上一个页面
  if (openedSubPage.value.length > 0) {
    const targetSubPage = openedSubPage.value[openedSubPage.value.length - 1];
    if (targetSubPage.pageSource == 'workflow') {
      await router.push({
        name: 'workflowEdit',
        params: {
          workflowCode: openedSubPage.value[openedSubPage.value.length - 1].pageCode
        }
      });
      initCurrentWorkflowEdit(currentApp.app_code, openedSubPage.value[openedSubPage.value.length - 1].pageCode);
    }
  } else {
    await router.push({
      name: 'appDetail',
      params: {
        app_code: currentApp.app_code
      }
    });
  }
  localStorage.setItem('openedSubPage', JSON.stringify(openedSubPage.value));
}
async function openWorkFlowEdit(workflow: IWorkflowMetaInfo) {
  // 加入到已打开的子页面列表
  let findFlag = false;
  openedSubPage.value.forEach(item => {
    if (item.pageCode === workflow.workflow_code) {
      findFlag = true;
    }
  });
  if (!findFlag) {
    openedSubPage.value.push({
      appCode: currentApp.app_code,
      pageCode: workflow.workflow_code,
      pageName: workflow.workflow_name,
      pageIcon: workflow.workflow_icon,
      pageSource: 'workflow'
    });
  }
  // 跳转到子页面
  await router.push({
    name: 'workflowEdit',
    params: {
      workflowCode: workflow.workflow_code
    }
  });
  // 保存至localstorage
  localStorage.setItem('openedSubPage', JSON.stringify(openedSubPage.value));
  // 更新当前编辑的agent
  await initCurrentWorkflowEdit(currentApp.app_code, workflow.workflow_code);
  // 获取测试会话
  await getWorkFlowSession(workflow);
  currentPage.value = {
    appCode: currentApp.app_code,
    pageCode: workflow.workflow_code,
    pageName: workflow.workflow_name,
    pageIcon: workflow.workflow_icon,
    pageSource: 'workflow'
  };
  showAgentApp.value = false;
  showNodeFlag.value = false;
  showEdgeFlag.value = false;
}
async function addNewTestSession() {
  CurrentEditSession.value = await agentAppRef.value?.initTestSession(currentApp.app_code, null);
  showAgentApp.value = true;
  getWorkFlowSession(CurrentEditFlow.value);
}
function cancelLoadWorkFlow() {
  showNewWorkFlowUploadForm.value = false;
  uploadWorkFlowLoading.value = false;
  newUploadWorkFlowForm.uploadFileUrl = '';
  uploadRef.value!.clearFiles();
}
async function openConfigEdit(area: IConfigArea) {
  let findFlag = false;
  openedSubPage.value.forEach(item => {
    if (item.pageCode === area.area) {
      findFlag = true;
    }
  });
  if (!findFlag) {
    openedSubPage.value.push({
      appCode: currentApp.app_code,
      pageCode: area.area,
      pageName: area.label,
      pageIcon: area.icon,
      pageSource: 'appConfig'
    });
  }
  await router.push({
    name: 'configEdit',
    params: {
      area: area.area
    }
  });
  // 保存至localstorage
  localStorage.setItem('openedSubPage', JSON.stringify(openedSubPage.value));
  currentPage.value  = {
    appCode: currentApp.app_code,
    pageCode: area.area,
    pageName: area.label,
    pageIcon: area.icon,
    pageSource: 'appConfig'
  };
}
async function initCurrentSubPage() {
  if (router.currentRoute.value.name == 'workflowEdit') {
    currentPage.value = {
      appCode: currentApp.app_code,
      pageCode: router.currentRoute.value.params.workflowCode,
      pageName: CurrentEditFlow.value.workflow_name,
      pageIcon: CurrentEditFlow.value.workflow_icon,
      pageSource: 'workflow'
    };
  } else if (router.currentRoute.value.name == 'configEdit') {
    currentPage.value = {
      appCode: currentApp.app_code,
      pageCode: router.currentRoute.value.params.area,
      pageName: currentAppConfigArea.value.label,
      pageIcon: currentAppConfigArea.value.icon,
      pageSource: 'appConfig'
    };
  }
}
function beginRestoreWorkflowSchema(workflow) {
  showRestoreConfirm.value = true;
  restoreFlow.value = workflow;
}
async function restoreWorkflowSchema() {
  const res = await workflowRestore({
    app_code: currentApp.app_code,
    workflow_code: restoreFlow.value.workflow_code
  })
  if (!res.error_status) {
    showRestoreConfirm.value = false;
    ElMessage.success('恢复成功');
    await openWorkFlowEdit(restoreFlow.value);
  } else {
    ElMessage.error('恢复失败');
  }
  restoreFlow.value = null;
}
watch(
    () => prop.appCode,
    async newVal => {
      if (newVal) {
        await initCurrentApp(newVal);
      }
    },
    { immediate: true }
);
onMounted(async () => {
  if (!prop.appCode) {
    await router.push({
      name: 'appList'
    });
    return;
  }
  if (router.currentRoute.value.query?.showPanel != 'false') {
    openPanel();
  } else {
    closePanel();
  }
  if (router.currentRoute.value.name == 'appDetail') {
    await autoOpenFlow();
  }
  initCurrentSubPage();
});
</script>

<template>
  <el-container>
    <el-header style="padding: 0">
      <div id="app-head">
        <div id="app-head-left">
          <div>
            <el-image :src="currentApp.app_icon" class="icon-button" />
          </div>
          <div>
            <el-text style="font-size: 20px; max-width: 300px; min-width: 200px" truncated>
              {{ currentApp?.app_name }}
            </el-text>
          </div>
          <div>
            <el-button :icon="Edit" text @click="metaDialogFlag = true" />
          </div>
        </div>
        <div id="app-head-middle">
          <el-radio-group v-model="currentAppMode">
            <el-radio-button label="logic" value="logic">业务逻辑</el-radio-button>
            <el-radio-button label="logic" value="ui" disabled>前端组件</el-radio-button>
          </el-radio-group>
        </div>
        <div id="app-head-right">
          <div>
            <el-dropdown>
              <el-icon class="more-filled">
                <MoreFilled />
              </el-icon>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item disabled>复制</el-dropdown-item>
                  <el-dropdown-item disabled>删除</el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </div>
          <el-divider direction="vertical" />
          <div>
            <el-button type="primary" @click="routerToPublish()"> 发布应用 </el-button>
          </div>
        </div>
      </div>
    </el-header>
    <el-main style="padding: 0">
      <el-container>
        <el-aside v-if="showSetPanel">
          <div id="panel-box">
            <div id="panel-head">
              <div>
                <el-text> 控制面板 </el-text>
              </div>
              <div>
                <el-button text :icon="Expand" class="icon-button" @click="closePanel" />
              </div>
            </div>
            <el-scrollbar>
              <div id="panel-body">
                <div class="panel-item">
                  <div class="panel-item-head">
                    <div class="panel-item-head-left" @click="currentFlowListDetail = !currentFlowListDetail">
                      <div class="std-middle-box">
                        <el-icon v-if="currentFlowListDetail" text class="panel-icon">
                          <ArrowDown />
                        </el-icon>
                        <el-icon v-else text class="panel-icon">
                          <ArrowRight />
                        </el-icon>
                      </div>
                      <div>
                        <el-text class="panel-label"> 流程设计 </el-text>
                      </div>
                    </div>
                    <div class="panel-item-head-right">
                      <el-dropdown>
                        <el-button text :icon="Plus" />
                        <template #dropdown>
                          <el-dropdown-menu>
                            <el-dropdown-item @click="beginInitWorkFlow"> 新建工作流 </el-dropdown-item>
                            <el-dropdown-item @click="showNewWorkFlowUploadForm = true"> 导入工作流 </el-dropdown-item>
                          </el-dropdown-menu>
                        </template>
                      </el-dropdown>
                    </div>
                  </div>
                  <div v-show="currentFlowListDetail" class="panel-item-body">
                    <div
                        v-for="workflow in currentFlowList"
                        :key="workflow.id"
                        class="agent-box"
                        :class="workflow.workflow_code === currentPage?.pageCode ? 'agent-box-active' : ''"
                        @click="openWorkFlowEdit(workflow)"
                    >
                      <div class="agent-box-left">
                        <div>
                          <el-image :src="workflow.workflow_icon" class="agent-icon" />
                        </div>
                        <el-tooltip :content="'创建时间: ' + workflow.create_time">
                          <div>
                            <el-text> {{ workflow.workflow_name }} </el-text>
                          </div>
                        </el-tooltip>
                        <div v-show="workflow?.workflow_is_main">
                          <el-tag type="success" size="small">主流程</el-tag>
                        </div>
                      </div>
                      <div @click.stop>
                        <el-dropdown trigger="click">
                          <el-icon style="cursor: pointer">
                            <MoreFilled />
                          </el-icon>
                          <template #dropdown>
                            <el-dropdown-menu>
                              <el-dropdown-item @click="beginUpdateWorkFlow(workflow)"> 修改 </el-dropdown-item>
                              <el-dropdown-item @click="beginDeleteWorkFlow(workflow)">删除</el-dropdown-item>
                              <el-dropdown-item @click="setMainWorkflow(workflow)"> 设为主流程 </el-dropdown-item>
                              <el-dropdown-item @click="exportTargetWorkflow(workflow)"> 导出 </el-dropdown-item>
                              <el-dropdown-item @click="beginRestoreWorkflowSchema(workflow)"> 恢复 </el-dropdown-item>
                            </el-dropdown-menu>
                          </template>
                        </el-dropdown>
                      </div>
                    </div>
                  </div>
                  <div v-show="!currentFlowList?.length && currentFlowListDetail">
                    <el-empty description="暂无主流程，赶快创建一个吧！" />
                  </div>
                </div>
<!--                <div class="panel-item">-->
<!--                  <div class="panel-item-head">-->
<!--                    <div class="panel-item-head-left" @click="currentResourceListDetail = !currentResourceListDetail">-->
<!--                      <div class="std-middle-box">-->
<!--                        <el-icon v-if="currentResourceListDetail" text class="panel-icon">-->
<!--                          <ArrowDown />-->
<!--                        </el-icon>-->
<!--                        <el-icon v-else text class="panel-icon">-->
<!--                          <ArrowRight />-->
<!--                        </el-icon>-->
<!--                      </div>-->
<!--                      <div>-->
<!--                        <el-text class="panel-label"> 资源库 </el-text>-->
<!--                      </div>-->
<!--                    </div>-->

<!--                    <div class="panel-item-head-right">-->
<!--                      <el-button text :icon="Plus" />-->
<!--                    </div>-->
<!--                  </div>-->
<!--                  <div v-show="currentResourceListDetail" class="panel-item-body">-->
<!--                    <div v-for="agent in currentResourceList" :key="agent.id">-->
<!--                      <el-text> {{ agent.flow_name }} </el-text>-->
<!--                    </div>-->
<!--                  </div>-->
<!--                </div>-->
                <div class="panel-item">
                  <div class="panel-item-head">
                    <div class="panel-item-head-left" @click="currentAppConfigFlag = !currentAppConfigFlag">
                      <div class="std-middle-box">
                        <el-icon v-if="currentAppConfigFlag" text class="panel-icon">
                          <ArrowDown />
                        </el-icon>
                        <el-icon v-else text class="panel-icon">
                          <ArrowRight />
                        </el-icon>
                      </div>
                      <div>
                        <el-text class="panel-label"> 应用配置 </el-text>
                      </div>
                    </div>
                  </div>
                  <div v-show="currentAppConfigFlag" class="panel-item-body">
                    <div
                        v-for="area in configArea"
                        :key="area.area"
                        class="agent-box"
                        :class="area.area === currentPage?.pageCode ? 'agent-box-active' : ''"
                        @click="openConfigEdit(area)"
                    >
                      <div class="agent-box-left">
                        <div>
                          <el-image :src="area.icon" class="agent-icon" />
                        </div>
                        <div>
                          <el-text> {{ area.label }} </el-text>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="panel-item" v-show="currentPage.pageSource == 'workflow'">
                  <div class="panel-item-head">
                    <div class="panel-item-head-left" @click="currentSessionListFlag = !currentSessionListFlag">
                      <div class="std-middle-box">
                        <el-icon v-if="currentSessionListFlag" text class="panel-icon">
                          <ArrowDown />
                        </el-icon>
                        <el-icon v-else text class="panel-icon">
                          <ArrowRight />
                        </el-icon>
                      </div>
                      <div>
                        <el-text class="panel-label"> 测试会话 </el-text>
                      </div>
                    </div>

                    <div class="panel-item-head-right">
                      <el-button text :icon="Plus" @click="addNewTestSession" />
                    </div>
                  </div>
                  <div v-show="currentSessionListFlag" class="panel-item-body">
                    <div
                        v-for="session in currentSessionList"
                        :key="session.id"
                        class="session-item-box"
                        :class="
                        session.session_code === CurrentEditSession?.session_code ? 'session-item-box-active' : ''
                      "
                        @click="changeTestSession(session)"
                    >
                      <div v-if="session?.is_edit" style="z-index: 999">
                        <el-input
                            ref="currentSessionTopicInputRef"
                            v-model="session.session_topic"
                            placeholder="请输入会话名称"
                            @change="panelRewriteSessionTopic(session)"
                        />
                      </div>
                      <div v-else class="session-topic-box">
                        <el-text
                            truncated
                            class="session-topic-text"
                            :class="{
                            'session-topic-text-active': CurrentEditSession?.id == session.id && CurrentEditSession?.id
                          }"
                        >
                          {{ session?.session_topic }}
                        </el-text>
                      </div>
                      <div
                          v-show="CurrentEditSession?.id == session.id && CurrentEditSession?.id"
                          class="std-middle-box session-more-button"
                      >
                        <el-popover ref="sessionButtonsRef" trigger="click">
                          <template #reference>
                            <div class="std-middle-box">
                              <el-image src="images/dot_list_grey.svg" />
                            </div>
                          </template>
                          <div id="session-manage-box">
                            <div class="session-manage-button" @click="focusSessionTopicInput(session)">
                              <div class="std-middle-box">
                                <el-image src="images/edit_03_grey.svg" class="session-manage-button-icon" />
                              </div>
                              <div class="std-middle-box">
                                <el-text class="session-manage-button-text"> 重命名 </el-text>
                              </div>
                            </div>
                            <el-divider style="margin: 8px 0" />
                            <div class="session-manage-button" @click="panelDeleteSession(session)">
                              <div class="std-middle-box">
                                <el-image src="images/delete_red.svg" class="session-manage-button-icon" />
                              </div>
                              <div class="std-middle-box">
                                <el-text class="session-manage-button-text" style="color: red"> 删除 </el-text>
                              </div>
                            </div>
                          </div>
                        </el-popover>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </el-scrollbar>
          </div>
        </el-aside>
        <el-main style="padding: 0">
          <el-header style="padding: 0">
            <div id="page-router-area">
              <div v-if="!showSetPanel" class="page-router">
                <el-button text :icon="Fold" class="icon-button" @click="openPanel" />
              </div>
              <div
                  v-for="item in openedSubPage"
                  :key="item.pageCode"
                  class="page-router"
                  :class="currentPage?.pageCode === item.pageCode ? 'page-router-active' : ''"
                  @click="openSubPage(item)"
              >
                <div>
                  <el-image :src="item.pageIcon" class="panel-icon" />
                </div>
                <div>
                  <el-text>
                    {{ item.pageName }}
                  </el-text>
                </div>
                <div>
                  <el-button text :icon="Close" class="icon-button" @click.stop="closeSubPage(item)" />
                </div>
              </div>
            </div>
          </el-header>
          <router-view />
        </el-main>
      </el-container>
    </el-main>
  </el-container>
  <el-dialog v-model="metaDialogFlag" title="编辑应用">
    <el-form ref="currentAppRef" :model="currentApp" label-position="top" :rules="newAppFormRules">
      <el-form-item label="应用名称" prop="app_name" required>
        <el-input v-model="currentApp.app_name" @keydown.enter.prevent />
      </el-form-item>
      <el-form-item label="应用描述" prop="app_desc" required>
        <el-input v-model="currentApp.app_desc" type="textarea" :rows="8" show-word-limit maxlength="500" />
      </el-form-item>
      <el-form-item label="应用图标" prop="app_icon" required>
        <el-upload
            drag
            :show-file-list="false"
            accept=".png, .jpg, .jpeg, .gif, .bmp, .webp"
            name="app_icon"
            :headers="uploadHeader"
            :before-upload="beforeAvatarUpload"
            :action="api.app_icon_upload"
            :on-success="handleAvatarUploadSuccess"
            style="min-width: 160px"
        >
          <div v-if="currentApp.app_icon">
            <el-image :src="currentApp.app_icon" style="width: 40px; height: 40px" />
          </div>
          <div v-else>
            <el-avatar src="images/upload_cloud.svg" style="background: #f2f4f7" fit="scale-down" />
            <i class="el-icon-upload"></i>
            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
          </div>
        </el-upload>
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="metaDialogFlag = false"> 取消 </el-button>
      <el-button type="primary" @click="updateCurrentApp"> 更新 </el-button>
    </template>
  </el-dialog>
  <el-dialog v-model="showNewFlowForm" title="新建工作流">
    <el-form ref="newFlowFormRef" :model="defaultFlow" label-position="top" :rules="newFlowFormRules">
      <el-form-item label="工作流名称" prop="workflow_name" required>
        <el-input v-model="defaultFlow.workflow_name" placeholder="请输入工作流名称" @keydown.enter.prevent />
      </el-form-item>
      <el-form-item label="工作流描述" prop="workflow_desc" required>
        <el-input
            v-model="defaultFlow.workflow_desc"
            type="textarea"
            :rows="8"
            show-word-limit
            maxlength="500"
            placeholder="请输入工作流描述, 让大模型知道什么情况下进行调用"
        />
      </el-form-item>
      <el-form-item label="工作流图标" prop="workflow_icon" required>
        <el-upload
            drag
            :show-file-list="false"
            accept=".png, .jpg, .jpeg, .gif, .bmp, .webp"
            name="workflow_icon"
            :headers="uploadHeader"
            :before-upload="beforeAvatarUpload"
            :action="api.workflow_icon_upload"
            :on-success="handleWorkFlowIconUploadSuccess"
            style="min-width: 160px"
        >
          <div v-if="defaultFlow.workflow_icon">
            <el-image :src="defaultFlow.workflow_icon" style="width: 40px; height: 40px" />
          </div>
          <div v-else>
            <el-avatar src="images/upload_cloud.svg" style="background: #f2f4f7" fit="scale-down" />
            <i class="el-icon-upload"></i>
            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
          </div>
        </el-upload>
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="showNewFlowForm = false"> 取消 </el-button>
      <el-button type="primary" @click="newFlowFormSubmit"> 创建 </el-button>
    </template>
  </el-dialog>
  <el-dialog v-model="showDeleteFlowConfirm" title="删除工作流" width="30%">
    <el-result icon="warning" :title="'是否删除工作流：' + deleteFlow?.workflow_name + '？'" />
    <template #footer>
      <el-button @click="showDeleteFlowConfirm = false"> 取消 </el-button>
      <el-button type="danger" @click="confirmDeleteWorkFlow"> 确认 </el-button>
    </template>
  </el-dialog>
  <el-dialog v-model="showFlowUpdateForm" title="修改工作流">
    <el-form ref="FlowUpdateFormRef" :model="updateFlow" label-position="top" :rules="newFlowFormRules">
      <el-form-item label="名称" prop="workflow_name" required>
        <el-input
            v-model="updateFlow.workflow_name"
            :placeholder="'请输入' + updateFlow.workflow_name + '名称'"
            @keydown.enter.prevent
        />
      </el-form-item>
      <el-form-item label="描述" prop="workflow_desc" required>
        <el-input
            v-model="updateFlow.workflow_desc"
            type="textarea"
            :rows="8"
            show-word-limit
            maxlength="500"
            :placeholder="'请输入描述, 让大模型知道什么情况下进行调用'"
        />
      </el-form-item>
      <el-form-item label="图标" prop="workflow_icon" required>
        <el-upload
            drag
            :show-file-list="false"
            accept=".png, .jpg, .jpeg, .gif, .bmp, .webp"
            name="flow_icon"
            :headers="uploadHeader"
            :before-upload="beforeAvatarUpload"
            :action="api.workflow_icon_upload"
            :on-success="handleWorkFlowIconUploadSuccess"
            style="min-width: 160px"
        >
          <div v-if="updateFlow.workflow_icon">
            <el-image :src="updateFlow.workflow_icon" style="width: 40px; height: 40px" />
          </div>
          <div v-else>
            <el-avatar src="images/upload_cloud.svg" style="background: #f2f4f7" fit="scale-down" />
            <i class="el-icon-upload"></i>
            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
          </div>
        </el-upload>
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="showFlowUpdateForm = false"> 取消 </el-button>
      <el-button type="primary" @click="confirmUpdateWorkflow"> 更新 </el-button>
    </template>
  </el-dialog>
  <el-dialog v-model="showNewWorkFlowUploadForm" title="导入工作流" width="30%">
    <el-form
        ref="newUploadWorkFlowFormRef"
        v-loading="uploadWorkFlowLoading"
        element-loading-text="努力导入中..."
        :model="newUploadWorkFlowForm"
        :rules="newUploadWorkFlowFormRules"
        label-position="top"
    >
      <el-form-item label="上传工作流文件" prop="uploadFileUrl" required>
        <el-upload
            ref="uploadRef"
            drag
            :show-file-list="true"
            accept=".json"
            :limit="1"
            name="workflow_schema"
            :headers="uploadHeader"
            :action="api.workflow_upload"
            :on-exceed="handleExceed"
            :on-success="handleWorkFlowUploadSuccess"
            style="min-width: 160px; width: 100%"
        >
          <div>
            <el-avatar src="images/upload_cloud.svg" style="background: #f2f4f7" fit="scale-down" />
            <i class="el-icon-upload"></i>
            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
          </div>
        </el-upload>
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="cancelLoadWorkFlow"> 取消 </el-button>
      <el-button type="primary" @click="importTargetWorkflow"> 确认导入 </el-button>
    </template>
  </el-dialog>
  <el-dialog v-model="showRestoreConfirm" title="恢复工作流" width="30%">
    <el-result icon="warning" :title="'是否恢复工作流：' + restoreFlow.workflow_name + ',将工作流定义恢复至上一发布版本？'" />
    <template #footer>
      <el-button @click="showRestoreConfirm = false"> 取消 </el-button>
      <el-button type="primary" @click="restoreWorkflowSchema"> 确认 </el-button>
    </template>
  </el-dialog>
</template>

<style scoped>
.std-middle-box {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}
#app-head {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  padding: 12px;
  border-bottom: 1px solid #dcdfe6;
}
#app-head-left {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  min-width: 400px;
}
#app-head-middle {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  justify-content: center;
  min-width: 400px;
}
#app-head-right {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
}
.icon-button {
  width: 24px;
  height: 24px;
}
#panel-box {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: calc(100vh - 60px);
  border-right: 1px solid #dcdfe6;
}
#panel-head {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  padding: 12px;
  border-bottom: 1px solid #dcdfe6;
}
#panel-body {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
  max-height: calc(100vh - 240px);
}
.panel-item-head {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
}
.panel-item-head-left {
  cursor: pointer;
  display: flex;
  flex-direction: row;
  gap: 4px;
  width: 100%;
}
.panel-icon {
  width: 12px;
  height: 12px;
}
.panel-label {
  font-weight: 600;
}
.panel-item-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 8px 16px;
}
.agent-box {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  padding: 6px;
  background-color: #f9fafb;
  width: 100%;
  cursor: pointer;
  border-radius: 6px;
}
.agent-box-active {
  background-color: #e6f7ff; /* 浅蓝色背景 */
  border-left: 3px solid #1890ff; /* 左侧高亮色条 */
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1); /* 柔和阴影 */
  transform: translateY(-1px); /* 轻微上浮效果 */
  transition: all 0.2s ease; /* 平滑过渡 */
  font-weight: 500;
  /* 悬停效果增强 */
}
.agent-box:hover {
  background-color: #eff8ff;
}
.agent-box-left {
  display: flex;
  flex-direction: row;
  gap: 6px;
}
.agent-icon {
  width: 20px;
  height: 20px;
}
#page-router-area {
  display: flex;
  flex-direction: row;
  gap: 4px;
  padding: 6px;
  background-color: #f9fafb;
  min-height: 40px;
}
.page-router {
  display: flex;
  flex-direction: row;
  gap: 4px;
  padding: 8px;
  cursor: pointer;
  border-radius: 8px;
  &:hover {
    background: rgb(239, 239, 244);
  }
}
.page-router-active {
  background-color: #e6f7ff;
  border-left: 3px solid #1890ff;
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1); /* 柔和阴影 */
  font-weight: 500;
  transform: translateY(-1px);
  transition: all 0.2s ease; /* 平滑过渡 */
}

.session-topic-box {
  display: flex;
  flex-direction: row;
  gap: 8px;
  align-items: center;
  width: 100%;
}
.session-item-box {
  display: flex;
  flex-direction: row;
  gap: 8px;
  padding: 4px 8px;
  justify-content: space-between;
  align-items: center;
  border-radius: 8px;
  cursor: pointer;
  width: calc(100% - 16px);
  &:hover {
    background-color: #f5f8ff;
  }
  &:active {
    background-color: #d9d9d9;
  }
}
.session-item-box-active {
  background-color: #e6f7ff;
  border-left: 3px solid #1890ff;
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1); /* 柔和阴影 */
  font-weight: 500;
  transform: translateY(-1px);
  transition: all 0.2s ease; /* 平滑过渡 */
}
.session-manage-button {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  cursor: pointer;
  width: 100%;
  &:hover {
    background-color: #f5f8ff;
  }
  &:active {
    transform: scale(0.95);
  }
}
.session-manage-button-icon {
  width: 16px;
  height: 16px;
}
.session-manage-button-text {
  font-size: 14px;
  line-height: 20px;
  font-weight: 500;
  color: #101828;
}
.more-filled {
  cursor: pointer;
  &:focus {
    outline: none;
  }
}
</style>
